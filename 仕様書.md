# jinjya-api 技術仕様書

## 1. システム概要

### 1.1 プロジェクト概要
`jinjya-api`は、複数の神社（管理者）が独立してお神籤（おみくじ）を管理できる分散型API システムです。Cloudflare Workers プラットフォーム上に構築され、高い可用性とスケーラビリティを実現します。

### 1.2 主要機能
- **おみくじ投稿**: ユーザーがおみくじ結果を投稿
- **おみくじ抽選**: バッファされたおみくじからランダムに1つを抽選
- **神社管理**: 複数の神社の登録・管理
- **データ配信**: 定期的に各神社のGoogle Sheetsへデータ送信
- **バッファリング**: KVストアを使った一時的なデータ保存

### 1.3 対象ユーザー
- **一般ユーザー**: おみくじを引いて結果を投稿する参拝者
- **神社管理者**: 独自のGoogle Sheetsでおみくじデータを管理する運営者

## 2. 技術アーキテクチャ

### 2.1 プラットフォーム
- **実行環境**: Cloudflare Workers (Edge Computing)
- **ランタイム**: V8 JavaScript Engine
- **言語**: TypeScript (ES2021対応)
- **デプロイツール**: Wrangler CLI

### 2.2 ストレージ構成
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   KV Store      │    │   D1 Database   │    │ Google Sheets   │
│ (一時バッファ)   │    │ (神社マスタ)     │    │ (最終データ保存) │
└─────────────────┘    └─────────────────┘    └─────────────────┘
        ↑                      ↑                      ↑
        │                      │                      │
        └──────────────────────┼──────────────────────┘
                               │
                    ┌─────────────────┐
                    │ Cloudflare      │
                    │ Workers         │
                    │ (jinjya-api)    │
                    └─────────────────┘
```

### 2.3 使用技術
- **バリデーション**: Zod v3.x
- **HTTP**: Fetch API (Workers標準)
- **データベース**: Cloudflare D1 (SQLite互換)
- **キャッシュ**: Cloudflare KV
- **スケジューラー**: Cloudflare Cron Triggers
- **テスト**: Vitest + Cloudflare Workers Test Pool

### 2.4 ドメイン設定
- **本番環境**: `bakasekai.net/api/*`
- **開発環境**: `*.jinjya-api.workers.dev`

## 3. API仕様

### 3.1 エンドポイント一覧
| メソッド | エンドポイント | 概要 | 認証 |
|---------|---------------|------|------|
| GET | `/api/draw` | おみくじ抽選 | なし |
| POST | `/api/submit` | おみくじ投稿 | なし |
| POST | `/api/publish` | 手動データ配信 | なし |
| GET | `/api/read` | バッファデータ読み取り | なし |
| GET | `/api/jinjya/list` | 神社一覧取得 | なし |
| POST | `/api/jinjya/register` | 神社登録 | なし |
| POST | `/api/jinjya/deregister` | 神社削除 | なし |

### 3.2 詳細API仕様

#### 3.2.1 おみくじ抽選 - GET /api/draw
**概要**: バッファされたおみくじからランダムに1つを抽選して返す

**リクエスト**:
```http
GET /api/draw?jinjya=furin
```

**レスポンス**:
```json
{
  "jinjya": "furin",
  "fortune": "大吉",
  "message": "今日は最高の日です",
  "tags": {
    "恋愛": "良好",
    "仕事": "順調",
    "健康": "絶好調",
    "金運": "金運上昇",
    "学業": "集中力抜群"
  },
  "extra": {
    "ラッキーカラー": "金",
    "ラッキーアニマル": "龍",
    "開運方位": "東"
  }
}
```

**エラーレスポンス**:
- `404`: "まだ誰も奉納していません🙏" (バッファが空の場合)
- `500`: "おみくじが壊れています…" (データ取得失敗)

#### 3.2.2 おみくじ投稿 - POST /api/submit
**概要**: おみくじ結果をバッファに保存

**リクエスト**:
```json
{
  "jinjya": "furin",
  "fortune": "中吉",
  "message": "何事も成るようになります",
  "tags": {
    "恋愛": "穏やか",
    "仕事": "注意深く",
    "健康": "良好",
    "金運": "ちょっと無駄遣い",
    "学業": "コツコツやるべし"
  },
  "extra": {
    "ラッキーカラー": "青",
    "ラッキーアニマル": "狐",
    "開運方位": "南東"
  }
}
```

**バリデーション規則**:
- 各フィールド最大200文字（tags/extra内の値も含む）
- NGワードフィルタリング適用（tags/extra内の値も含む）
- Zodスキーマによる型検証
- tags: カテゴリ別おみくじ結果（任意）
- extra: 追加情報（任意）

**レスポンス**:
- `200`: "奉納を受け付けました🙏"
- `400`: "Invalid submission" / "Too long input" / "Inappropriate content"

#### 3.2.3 データ配信 - POST /api/publish
**概要**: 1時間以内のバッファデータを各神社のGoogle Sheetsに送信

**処理フロー**:
1. 1時間以内のバッファデータを取得
2. 神社IDごとにグループ化
3. D1から各神社のspreadsheet_url取得
4. Google Sheets WebhookにPOST送信
5. 成功した場合はバッファから削除

**レスポンス**:
```json
{
  "success": 2,
  "errors": []
}
```

#### 3.2.4 神社登録 - POST /api/jinjya/register
**概要**: 新しい神社とGoogle Sheets URLを登録

**リクエスト**:
```json
{
  "id": "furin",
  "name": "風鈴神社", 
  "spreadsheet_url": "https://script.google.com/macros/s/.../exec",
  "owner": "eightman"
}
```

**レスポンス**:
- `201`: "神社を登録しました"
- `409`: "神社IDが既に存在します"
- `400`: "Missing required fields"

## 4. データベース設計

### 4.1 D1データベーススキーマ

#### 4.1.1 jinjyaテーブル
```sql
CREATE TABLE jinjya (
    id TEXT PRIMARY KEY,               -- 神社ID（一意識別子）
    name TEXT NOT NULL,                -- 神社名
    spreadsheet_url TEXT NOT NULL,     -- Google Apps Script WebhookURL
    owner TEXT NOT NULL,               -- 所有者識別子
    created_at INTEGER DEFAULT (strftime('%s', 'now')), -- 作成日時（Unix時間）
    CONSTRAINT unique_owner_name UNIQUE(owner, name)     -- 所有者+名前の組み合わせは一意
);
```

**インデックス**: 
- PRIMARY KEY: `id`
- UNIQUE: `(owner, name)`

### 4.2 KVストア設計

#### 4.2.1 バッファデータ
**キー形式**: `buffer:{jinjyaId}:{timestamp}`
**例**: `buffer:furin:1691234567890`

**値**: JSON形式のおみくじデータ
```json
{
  "jinjya": "furin",
  "fortune": "大吉",
  "message": "今日は素晴らしい日です",
  "tags": {
    "恋愛": "絶好調",
    "仕事": "成功",
    "健康": "良好",
    "金運": "金運上昇",
    "学業": "集中力抜群"
  },
  "extra": {
    "ラッキーカラー": "金",
    "ラッキーアニマル": "龍",
    "開運方位": "東"
  }
}
```

**TTL**: 自動削除なし（手動削除のみ）
**上限**: 1,000件（超過時は古いものから削除）

## 5. データフロー

### 5.1 おみくじ投稿→抽選フロー
```
[ユーザー] 
    ↓ POST /api/submit
[Validation & NGWord Check]
    ↓ KV Store
[Buffer: buffer:jinjya:timestamp]
    ↓ GET /api/draw
[Random Selection]
    ↓ 
[別ユーザーに配信]
```

### 5.2 データ配信フロー
```
[Cron: 毎時0分] または [手動 POST /api/publish]
    ↓
[KV Store: 1時間以内のデータ取得]
    ↓
[神社IDごとにグループ化]
    ↓
[D1: spreadsheet_url取得]
    ↓
[Google Sheets Webhook送信]
    ↓
[成功時: KVから削除]
```

### 5.3 神社管理フロー
```
[神社管理者]
    ↓ POST /api/jinjya/register
[D1: 重複チェック]
    ↓
[D1: 神社情報保存]
    ↓
[以後のデータ配信対象に追加]
```

## 6. セキュリティ仕様

### 6.1 入力検証
- **Zodスキーマ**: 型安全性と構造検証
- **文字数制限**: 各フィールド最大200文字
- **NGワードフィルタ**: 不適切コンテンツの排除

### 6.2 NGワードシステム
```typescript
// src/constants/ngWords.ts
export const NG_WORDS = [
  // 機密情報のため実装詳細は非表示
];
```

### 6.3 データ保護
- **個人情報**: パスワード、メールアドレス等は保存しない
- **暗号化**: Cloudflare の TLS 1.3 による通信暗号化
- **アクセス制御**: Google Apps Script側で認証・認可制御

### 6.4 レート制限
- Cloudflare Workers標準のDDoS保護
- KVストア書き込み制限（1,000件上限）

### 6.5 脆弱性対策
- **SQLインジェクション**: D1 Prepared Statementsを使用
- **XSS**: JSON レスポンスのみ（HTML出力なし）
- **CSRF**: ステートレス設計により影響なし

## 7. 運用・保守仕様

### 7.1 監視項目
- **パフォーマンス**: Workers CPU使用時間
- **ストレージ**: KV使用量・D1クエリ数
- **エラー率**: 4xx/5xxレスポンス率
- **可用性**: エンドポイント応答時間

### 7.2 ログ出力
```typescript
// 構造化ログの例
console.log("📡 Request received:", {
    pathname,
    method: request.method,
});

console.error("[Submit Error]", err);
```

### 7.3 スケジュール処理
- **Cron設定**: `0 * * * *` (毎時0分実行)
- **処理内容**: バッファデータの神社別配信
- **障害時**: 手動 `/api/publish` で復旧可能

### 7.4 バックアップ戦略
- **D1データベース**: Cloudflare標準バックアップ
- **KV**: 一時的データのためバックアップ不要
- **設定ファイル**: Gitリポジトリで管理

### 7.5 災害復旧
1. **Workers停止**: Wrangler CLIで緊急デプロイ
2. **D1障害**: SQLダンプからの復旧
3. **KV障害**: データ損失受容（一時的データのため）

## 8. 開発環境・デプロイ

### 8.1 開発環境構築
```bash
# 依存関係インストール
npm install

# ローカル開発サーバー起動
npm run dev

# テスト実行
npm test

# 型定義生成
npm run cf-typegen
```

### 8.2 必要な環境変数・シークレット
```toml
# wrangler.toml
[vars]
# 本プロジェクトでは環境変数は未使用

# KVバインディング
kv_namespaces = [
  { binding = "JINJYA_STORE", id = "20e2e5bcc77f427c9e040c8f821b8e24" }
]

# D1バインディング  
[[d1_databases]]
binding = "JINJYA_DB"
database_name = "jinjya-db"
database_id = "352b1a3b-de37-417e-bd09-71c377a97574"
```

### 8.3 デプロイフロー
```bash
# 本番デプロイ
npm run deploy

# または
wrangler deploy
```

### 8.4 データベース初期化
```bash
# スキーマ適用
wrangler d1 execute JINJYA_DB --file=schema.sql
```

### 8.5 開発者向け情報

#### 8.5.1 プロジェクト構造
```
jinjya/
├── src/
│   ├── api/           # APIエンドポイント実装
│   ├── constants/     # 定数定義
│   ├── types/         # 型定義
│   └── index.ts       # メインエントリーポイント
├── test/              # テストコード
├── schema.sql         # データベーススキーマ
├── wrangler.toml      # Cloudflare Workers設定
└── package.json       # 依存関係管理
```

#### 8.5.2 重要な設計判断
- **ステートレス**: Workers間でのセッション共有なし
- **冪等性**: 同一データの重複送信を許容
- **非同期処理**: Cron + 手動実行のハイブリッド
- **分散アーキテクチャ**: 神社ごとの独立運用

#### 8.5.3 パフォーマンス考慮事項
- **KV制限**: 1MB/value、100KB/key
- **D1制限**: 1000 queries/day (開発)、1M queries/month (有料)
- **Workers制限**: 10ms CPU時間/request
- **メモリ**: 128MB/request

#### 8.5.4 今後の拡張可能性
- OAuth認証の追加
- おみくじカスタマイゼーション
- リアルタイム通知（WebSockets）
- 分析ダッシュボード
- 多言語対応

---

**最終更新**: 2025-08-03  
**バージョン**: 1.0.0  
**管理者**: eightman (eightman999@github)